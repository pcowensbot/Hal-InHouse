<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAL Knowledge Base</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()">‚ò∞</button>
                <div class="sidebar-avatar" id="sidebarAvatar"></div>
                <p class="subtitle">Knowledge Base</p>
            </div>

            <!-- Books List -->
            <div class="kb-sidebar-section">
                <div class="kb-sidebar-header">
                    <h4>üìö My Books</h4>
                    <button onclick="showCreateBookModal()" class="btn-icon-only" title="Create new book">+</button>
                </div>
                <div id="booksList" class="books-list">
                    <!-- Books will be loaded here -->
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-info">
                    <span id="userName"></span>
                </div>
                <div class="footer-buttons">
                    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                        <span class="btn-icon">üåô</span>
                    </button>
                    <button id="chatBtn" class="btn btn-primary btn-sm">
                        <span class="btn-icon">üí¨</span>
                        <span class="btn-text">My Chat</span>
                    </button>
                    <button id="profileBtn" class="btn btn-secondary btn-sm">
                        <span class="btn-icon">‚öôÔ∏è</span>
                        <span class="btn-text">Profile</span>
                    </button>
                    <button id="dashboardBtn" class="btn btn-primary btn-sm" style="display: none;">
                        <span class="btn-icon">üìä</span>
                        <span class="btn-text">Dashboard</span>
                    </button>
                    <button id="logoutBtn" class="btn btn-secondary btn-sm">
                        <span class="btn-icon">üö™</span>
                        <span class="btn-text">Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Backdrop -->
        <div class="mobile-backdrop" id="mobileBackdrop" onclick="closeSidebar()"></div>

        <!-- Main Content Area -->
        <div class="chat-main">
            <div id="kbHeader" class="chat-header">
                <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">‚ò∞</button>
                <h3 id="kbTitle">üìö Knowledge Base</h3>
                <div class="header-actions">
                    <div id="trainingBadge" class="training-badge" title="Training samples marked" style="display: none;">
                        <span class="brain-icon">üß†</span>
                        <span id="trainingCount">0</span>
                    </div>
                    <button onclick="showAutoOrganizeModal()" class="btn btn-primary btn-sm" title="AI-powered organization">
                        <span>ü§ñ Auto-Organize</span>
                    </button>
                    <button onclick="showImportModal()" class="btn btn-secondary btn-sm" title="Import book from friend">
                        <span>üì• Import</span>
                    </button>
                    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">üåô</button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="kb-search-bar">
                <input type="text" id="searchInput" placeholder="üîç Search your knowledge base..." onkeyup="handleSearchKeyup(event)">
                <select id="bookFilter" onchange="filterNotes()">
                    <option value="">All Books</option>
                </select>
            </div>

            <!-- Content Area -->
            <div id="kbContent" class="kb-content">
                <!-- Welcome / Empty State -->
                <div id="welcomeMessage" class="welcome-message">
                    <h1>üìö Knowledge Base</h1>
                    <p>Star messages from your chats to save them here.</p>
                    <p>Organize them into books, mark them for AI training, and share with friends!</p>
                </div>

                <!-- Notes List -->
                <div id="notesList" class="notes-list" style="display: none;">
                    <!-- Notes will be loaded here -->
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="search-results" style="display: none;">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Book Modal -->
    <div id="createBookModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö Create New Book</h2>
                <button onclick="closeCreateBookModal()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <form id="createBookForm">
                    <div class="form-group">
                        <label>Book Name</label>
                        <input type="text" id="bookName" required placeholder="e.g., Python Notes, Recipes, Family Tips">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="bookDescription" rows="3" placeholder="What is this book about?"></textarea>
                    </div>
                    <div id="createBookError" class="error"></div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeCreateBookModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Book</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Note Modal -->
    <div id="editNoteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Note</h2>
                <button onclick="closeEditNoteModal()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <form id="editNoteForm">
                    <input type="hidden" id="editNoteId">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="editNoteTitle" placeholder="Give this note a title">
                    </div>
                    <div class="form-group">
                        <label>Your Notes</label>
                        <textarea id="editNoteContent" rows="5" placeholder="Add your thoughts, annotations, or context"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Book</label>
                        <select id="editNoteBook">
                            <option value="">No Book (Loose Note)</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeEditNoteModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Book Modal -->
    <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì• Import Book</h2>
                <button onclick="closeImportModal()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <p>Import a book shared by a friend (JSON file)</p>
                <input type="file" id="importFile" accept=".json" onchange="handleImportFile(event)">
                <div id="importPreview" style="display: none; margin-top: 15px; padding: 15px; background: var(--background); border-radius: 8px;">
                    <h3>Preview:</h3>
                    <p><strong>Book:</strong> <span id="importBookName"></span></p>
                    <p><strong>Notes:</strong> <span id="importNoteCount"></span></p>
                    <p><strong>Exported by:</strong> <span id="importExportedBy"></span></p>
                </div>
                <div id="importError" class="error"></div>
                <div class="modal-actions">
                    <button type="button" onclick="closeImportModal()" class="btn btn-secondary">Cancel</button>
                    <button id="importBtn" onclick="confirmImport()" class="btn btn-primary" disabled>Import Book</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-Organize Modal -->
    <div id="autoOrganizeModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ü§ñ Auto-Organize with AI</h2>
                <button onclick="closeAutoOrganizeModal()" class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div id="organizeLoading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Analyzing your notes with local AI...</p>
                    <p style="font-size: 0.9em; color: var(--text-secondary);">This may take 10-30 seconds</p>
                </div>

                <div id="organizeSuggestions" style="display: none;">
                    <p style="margin-bottom: 20px;">AI analyzed your notes and suggests these book groupings. Select which ones to create:</p>

                    <div id="suggestedBooksList" class="suggested-books-list">
                        <!-- Suggestions will be loaded here -->
                    </div>

                    <div id="uncategorizedSection" style="display: none; margin-top: 20px; padding: 15px; background: var(--background); border-radius: 8px;">
                        <h4>üìÑ Uncategorized Notes (<span id="uncategorizedCount">0</span>)</h4>
                        <p style="font-size: 0.9em; color: var(--text-secondary);">These notes didn't fit into any clear topic group</p>
                    </div>
                </div>

                <div id="organizeError" class="error"></div>

                <div class="modal-actions">
                    <button type="button" onclick="closeAutoOrganizeModal()" class="btn btn-secondary">Cancel</button>
                    <button id="startOrganizeBtn" onclick="startAutoOrganize()" class="btn btn-primary">Analyze Notes</button>
                    <button id="confirmOrganizeBtn" onclick="confirmAutoOrganize()" class="btn btn-primary" style="display: none;">Create Selected Books</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/knowledge.js"></script>
</body>
</html>
