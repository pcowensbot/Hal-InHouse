// Prisma schema for HAL - Home AI Box
// Single household, parents + kids, conversation tracking

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String
  firstName     String
  role          Role           @default(CHILD)
  createdAt     DateTime       @default(now())
  conversations Conversation[]
  books         Book[]
  starredNotes  StarredNote[]
  devices       Device[]
  trainingJobs  TrainingJob[]

  @@map("users")
}

enum Role {
  PARENT
  CHILD
}

model Conversation {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String    @default("New Chat")
  starred         Boolean   @default(false) // Star to keep at top
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? // Soft delete timestamp
  deletedBy       String?   // User ID who deleted it
  permanentDelete Boolean   @default(false) // Flag for final deletion
  messages        Message[]

  @@index([userId])
  @@index([deletedAt])
  @@index([starred])
  @@map("conversations")
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String        // "user" or "assistant"
  content        String        @db.Text
  imageUrl       String?       // For generated images
  modelUsed      String        @default("llama3.1:8b")
  createdAt      DateTime      @default(now())
  starredNotes   StarredNote[]

  @@index([conversationId])
  @@map("messages")
}

model Settings {
  id              Int      @id @default(1)
  householdName   String   @default("HAL")
  imageGenEnabled Boolean  @default(false)
  defaultModel    String   @default("llama3.1:8b")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("settings")
}

model InviteCode {
  id          String    @id @default(uuid())
  code        String    @unique
  createdBy   String    // Parent user ID who created it
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // Optional expiration
  usedAt      DateTime? // When it was used
  usedBy      String?   // User ID who used it
  isActive    Boolean   @default(true)
  emailedTo   String?   // Email address it was sent to
  emailedAt   DateTime? // When it was emailed

  @@index([code])
  @@index([createdBy])
  @@map("invite_codes")
}

model Book {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  description       String?
  markedForTraining Boolean        @default(false) // Mark entire book for fine-tuning
  isPublic          Boolean        @default(false) // Allow export/sharing
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  notes             StarredNote[]

  @@index([userId])
  @@index([markedForTraining])
  @@map("books")
}

model StarredNote {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageId         String
  message           Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  title             String?   // User's custom title/caption
  note              String?   @db.Text // User's notes about this starred item
  bookId            String?
  book              Book?     @relation(fields: [bookId], references: [id], onDelete: SetNull)
  markedForTraining Boolean   @default(false) // Mark for fine-tuning
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([messageId])
  @@index([bookId])
  @@index([markedForTraining])
  @@map("starred_notes")
}

model Device {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  apiKeyHash  String    @unique // SHA-256 hash of the API key
  lastUsedAt  DateTime?
  requestCount Int      @default(0) // Track usage
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([apiKeyHash])
  @@map("devices")
}

model TrainingJob {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String    // User-friendly name for this training run
  baseModel       String    // Model to fine-tune from (e.g., "llama3.1:8b")
  status          TrainingStatus @default(QUEUED)
  trainingMethod  String    @default("lora") // "lora", "qlora", "full"
  datasetSize     Int       @default(0) // Number of training samples
  progress        Float     @default(0) // 0-100 percentage
  currentEpoch    Int?
  totalEpochs     Int       @default(3)
  loss            Float?    // Current training loss
  outputModel     String?   // Name of the resulting model
  errorMessage    String?   @db.Text
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("training_jobs")
}

enum TrainingStatus {
  QUEUED
  PREPARING
  TRAINING
  COMPLETED
  FAILED
  CANCELLED
}
