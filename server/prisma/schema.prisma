// Prisma schema for HAL - Home AI Box
// Single household, parents + kids, conversation tracking

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String
  firstName     String
  role          Role           @default(CHILD)
  createdAt     DateTime       @default(now())
  conversations Conversation[]
  books         Book[]
  starredNotes  StarredNote[]
  devices       Device[]

  @@map("users")
}

enum Role {
  PARENT
  CHILD
}

model Conversation {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String    @default("New Chat")
  starred         Boolean   @default(false) // Star to keep at top
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? // Soft delete timestamp
  deletedBy       String?   // User ID who deleted it
  permanentDelete Boolean   @default(false) // Flag for final deletion
  messages        Message[]

  @@index([userId])
  @@index([deletedAt])
  @@index([starred])
  @@map("conversations")
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String        // "user" or "assistant"
  content        String        @db.Text
  imageUrl       String?       // For generated images
  modelUsed      String        @default("llama3.1:8b")
  createdAt      DateTime      @default(now())
  starredNotes   StarredNote[]

  @@index([conversationId])
  @@map("messages")
}

model Settings {
  id              Int      @id @default(1)
  householdName   String   @default("HAL")
  imageGenEnabled Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("settings")
}

model InviteCode {
  id          String    @id @default(uuid())
  code        String    @unique
  createdBy   String    // Parent user ID who created it
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // Optional expiration
  usedAt      DateTime? // When it was used
  usedBy      String?   // User ID who used it
  isActive    Boolean   @default(true)
  emailedTo   String?   // Email address it was sent to
  emailedAt   DateTime? // When it was emailed

  @@index([code])
  @@index([createdBy])
  @@map("invite_codes")
}

model Book {
  id          String         @id @default(uuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  notes       StarredNote[]

  @@index([userId])
  @@map("books")
}

model StarredNote {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageId   String
  message     Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  title       String?   // User's custom title/caption
  note        String?   @db.Text // User's notes about this starred item
  bookId      String?
  book        Book?     @relation(fields: [bookId], references: [id], onDelete: SetNull)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([messageId])
  @@index([bookId])
  @@map("starred_notes")
}

model Device {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  apiKeyHash  String    @unique // SHA-256 hash of the API key
  lastUsedAt  DateTime?
  requestCount Int      @default(0) // Track usage
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([apiKeyHash])
  @@map("devices")
}
